<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="assets/img/DithereumIconFavicon.png">
    <title>Dithereum Testnet Explorer</title>
    <!-- Bootstrap -->
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous"> -->
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <style type="text/css">
      #loading {
          /*background:#21242d url('assets/img/Bouncy-Preloader.gif') no-repeat center center;*/
          background:#fff url('assets/img/loader.gif') no-repeat center center;
          position: fixed;
          width: 100%;
	        height: 100vh;
          z-index: 9999999;
      }
    </style>
  </head>
  <body>
    <header>
      <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand logo" href="index.html">
          <img src="assets/img/logo.png">
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item mr-3">
              <button id="addDTHNetwork" style="margin-top: 15px;" class="btn btn-outline-primary btn-sm"><img src="assets/img/metamask.png" alt="metamask" style="width: 16px;margin-right: 4px;">Add DTH Network</button>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://t.me/Dithereum" target="_blank"><i class="fa fa-telegram" aria-hidden="true"></i></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://twitter.com/dithereum" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://www.youtube.com/channel/UCDPzTaaVk4ywEsLaf6nLAeQ" target="_blank"><i class="fa fa-youtube-play" aria-hidden="true"></i></a>
            </li>
          </ul>
        </div>
      </nav>
    </header>
    <!-- <div id="loading"></div> -->
    <div class="container mt-5 height-min">
      
      <!-- row -->
      <div class="row">
        <div class="col-md-12 text-center mb-4">
          <h2>Dithereum Testnet Explorer</h2>
        </div>
      </div>
      <div class="row justify-content-center">
        <div class="col-md-6">
          <div class="input-group mb-3">
            <input type="text" class="form-control" id="txtInput" placeholder="Enter Txn Hash / Address" aria-label="Recipient's username" aria-describedby="basic-addon2">
            <div class="input-group-append">
              <button id="btnSearch" class="btn btn-primary" type="button">Search</button>
            </div>
          </div>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-xl-3 col-lg-3 col-md-6 col-sm-6 col-12">
          <div class="card gradient-deepblue">
            <div class="card-body">
              <h6 class="card-title">DTH PRICE</h6>
              <h5 class="card-title"><span>$0.01</span></h5>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-lg-3 col-md-6 col-sm-6 col-12">
          <div class="card gradient-orange">
            <div class="card-body">
              <h6 class="card-title">LATEST BLOCK</h6>
              <h5 class="card-title"><span id="latestBlock">0</span></h5>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-lg-3 col-md-6 col-sm-6 col-12">
          <div class="card gradient-ohhappiness">
            <div class="card-body">
              <h6 class="card-title">DTH MARKET CAP</h6>
              <h5 class="card-title"><span>$5,000,000</span></h5>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-lg-3 col-md-6 col-sm-6 col-12">
          <div class="card gradient-ibiza">
            <div class="card-body">
              <h6 class="card-title">ACTIVE VALIDATOR</h6>
              <h5 class="card-title"><span>21</span></h5>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-lg-6 text-center table-responsive">
          <table class="table blocksTable">
            <thead>
              <tr>
                <th scope="col">Latest Blocks</th>
                <th scope="col">Txs</th>
                <th scope="col">Timestamp</th>
                <th scope="col">Gas Used</th>
              </tr>
            </thead>
            <tbody id="blocksData">
              <tr>
                <td colspan="4"><img src="assets/img/loader.gif"></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="col-lg-6 text-center table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th scope="col">Latest Transactions</th>
                <th scope="col">From</th>
                <th scope="col">To</th>
                <th scope="col">Value</th>
              </tr>
            </thead>
            <tbody id="txData">
              <tr id="txLoader">
                <td colspan="4"><img src="assets/img/loader.gif"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <footer class="footer bg-light py-3 mt-5">
      <div class="container">
      <div class="row">
        <div class="col-md-12 text-center">
          <p class="m-0">Â© 2021 - 2021 Dithereum. All rights reserved.</p>
        </div>
      </div>
      </div>
    </footer>
<!-- Bootstrap -->
    <script src="assets/js/jquery-3.5.1.slim.min.js"></script>
    <script src="assets/js/popper.min.js"></script>
    <script src="assets/js/bootstrap.min.js"></script>
<!-- Web3 -->
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script> -->
    <script>
      var provider = 'https://node-testnet.dithereum.io'; //Your Infura Endpoint
      var web3Provider = new Web3.providers.HttpProvider(provider);
      var web3;
      var oldBlock=0;
      web3 = new Web3(provider);
      async function init(){
        web3 = new Web3(provider);
       
      }
    setTimeout(init,200);
    setTimeout(function() {
      getBlocks(12);
    },1000);
    //setInterval(getBlocks,10000);
   // setTimeout(getTransactions,1000);
    //setInterval(getTransactions,5000);

    async function getBlocks(length){
        var latestBlock = await web3.eth.getBlockNumber();
        $('#latestBlock').html(latestBlock);
	if(latestBlock==0){return false;}
        var blocksData = '';
// List blocks in table
      for (var i = 0; i < length; i++) {
        var block =await web3.eth.getBlock(latestBlock - i);
        var latestTransactions =  block.transactions;
        console.log(latestTransactions);
        var number = block.number;
        const txCount = await web3.eth.getBlockTransactionCount(number);
        if(latestTransactions.length>0){
          const tx = await web3.eth.getTransaction(latestTransactions[0]);
          console.log(tx);
          const txHash = getShortAddress(latestTransactions[0]);
          const from=getShortAddress(tx.from);
          const to=getShortAddress(tx.to);
          var value=tx.value/1e18;
          value = value.toFixed(6);
          txData="<tr><td><a href='transaction.html?tx="+latestTransactions[i]+"'>" + txHash + "</a></td><td><a href='address.html?address="+tx.from+"'>" + from + "</a></td><td><a href='address.html?address="+tx.to+"'>" + to + "</a></td><td>" + value + " DTH</tr>";
            
            if ($('#txData tr').length==0){
            $('#txData').html(txData);
          }else{
              if($('#txData tr').length>11){
                $('#txData tr:last'). remove();
                $('#txData').prepend(txData);
              }else{
                $('#txData').prepend(txData);
              }
          }
        }
       
        var hash = block.hash;
        var time = block.timestamp;
        var gas = block.gasUsed;
        convertTimestamp(time);
            blocksData+="<tr class='txRow' id='row"+i+"'><td>" + number + "</td><td>" + txCount + "</td><td>" + time1 + "</td><td>" + gas + "</tr>";    
      }
      $('#blocksData').html(blocksData);

    }
    async function getTransactions(){
      var txData = '';
      var latestBlock = await web3.eth.getBlockNumber();
      if(latestBlock==0){return false;}
      var block =await web3.eth.getBlock(latestBlock - 1);
      var latestTransactions =  block.transactions;
      if(latestTransactions.length>0){
        $('#txLoader').remove();
      	  for(var i=0;i<=11;i++){
            if(latestTransactions[i]!=undefined){
                const txHash = getShortAddress(latestTransactions[i]);
                const tx = await web3.eth.getTransaction(latestTransactions[i]);
                const from=getShortAddress(tx.from);
                const to=getShortAddress(tx.to);
                var value=tx.value/1e18;
                value = value.toFixed(6);
                txData+="<tr><td><a href='transaction.html?tx="+latestTransactions[i]+"'>" + txHash + "</a></td><td><a href='address.html?address="+tx.from+"'>" + from + "</a></td><td><a href='address.html?address="+tx.to+"'>" + to + "</a></td><td>" + value + " DTH</tr>";
            }
          }
          
          
          if ($('#txData tr').length==0){
            $('#txData').html(txData);
          }else{
              if($('#txData tr').length>11){
                $('#txData tr:last'). remove();
              }
              $('#txData').prepend(txData);
          }
      }
   }
  //get short user address
  function getShortAddress(userAddress){
      firstFive   = userAddress.substring(0 , 12); 
      return firstFive+'...';
  }
//get short user Tx
  function getShortTx(txHash){
      firstFive   = txHash.substring(0 , 12); 
      return firstFive+'...';
  }
  function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
   }
  function convertTimestamp(time) {
            var d = new Date(time * 1000), // Convert the passed timestamp to milliseconds
                yyyy = d.getFullYear(),
                mm = ('0' + (d.getMonth() + 1)).slice(-2),  // Months are zero based. Add leading 0.
                dd = ('0' + d.getDate()).slice(-2),         // Add leading 0.
                hh = d.getHours(),
                h = hh,
                min = ('0' + d.getMinutes()).slice(-2),     // Add leading 0.
                ampm = 'AM',
                time;
        if (hh > 12) {
                h = hh - 12;
                ampm = 'PM';
            } else if (hh === 12) {
                h = 12;
                ampm = 'PM';
            } else if (hh == 0) {
                h = 12;
            }
// ie: 2014-03-24, 3:00 PM
            time1 = yyyy + '-' + mm + '-' + dd + ', ' + h + ':' + min + ' ' + ampm;
            return time1;
        }

    setInterval(getBlock,5000);

    async function getBlock(){
      var latestBlock = await web3.eth.getBlockNumber();
      if(oldBlock==0){
        oldBlock = latestBlock;
      }
      if(oldBlock<latestBlock){
        const length = latestBlock-oldBlock;
        oldBlock = latestBlock;
        getBlocks(12);
        //getTransactions();
      }
      $('#latestBlock').html(latestBlock);
    }

    $('#btnSearch').click(function(){
      const txtInput = $('#txtInput').val();
      
      if(txtInput.length==66){
          location.href="transaction.html?tx="+txtInput;
      }
      if(txtInput.length==42){
        location.href="address.html?address="+txtInput;
      }
    });
    function hideLoader() {
      $('#loading').hide();
    }
     $("#addDTHNetwork").click(async function(){
      if(window.ethereum) {
               
        window.ethereum.request({method: 'eth_requestAccounts'})
        window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{chainId: '0x22', //testnet '0x61',
                chainName: "Dithereum Testnet",
                nativeCurrency: {
                name: "Binance Chain",
                symbol: "DTH",
                decimals: 18
                },
                rpcUrls: ['https://node-testnet.dithereum.io/'],     blockExplorerUrls: ['https://testnet.dithereum.org/']                    
            }]
        })
            
      }
    });
    setTimeout(hideLoader, 10 * 1000);
    </script>
  </body>
</html>
